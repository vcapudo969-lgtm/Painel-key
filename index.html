<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Key System - Gamer</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;font-family:'Orbitron',sans-serif;}
body{height:100vh;display:flex;justify-content:center;align-items:center;background:linear-gradient(135deg,#0b0f16,#0a1c2e);color:#fff;}
.container{width:380px;background:#11162a;padding:40px;border-radius:15px;box-shadow:0 0 30px #6a00ff;text-align:center;}
h1{margin-bottom:15px;color:#6a00ff;font-size:28px;text-shadow:0 0 8px #fff;}
p{margin-bottom:20px;color:#aaa;}
input{width:100%;padding:12px;margin:10px 0;border:none;border-radius:8px;background:#1a1f35;color:#fff;font-size:16px;}
input::placeholder{color:#888;}
button{width:100%;padding:12px;margin:15px 0;border:none;border-radius:8px;background:linear-gradient(45deg,#6a00ff,#ff00aa);color:#fff;font-weight:bold;font-size:16px;cursor:pointer;transition:0.3s;}
button:hover{transform:scale(1.03);box-shadow:0 0 12px #ff00aa;}
small{color:#aaa;cursor:pointer;display:block;margin-top:10px;}
small:hover{color:#6a00ff;text-shadow:0 0 5px #fff;}
.error{color:#ff4d4d;margin-top:10px;font-weight:bold;}
.success{color:#00ff99;margin-top:10px;font-weight:bold;}
.menu-btn{position:fixed;top:10px;left:10px;background:#1a1f35;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;z-index:999;display:none;}
.menu{position:fixed;top:0;left:-260px;width:240px;height:100%;background:#0f1428;padding:15px;transition:0.3s;z-index:998;}
.menu button{width:100%;margin:5px 0;padding:10px;background:#1a1f35;color:white;border:none;border-radius:6px;cursor:pointer;}
.content{margin-left:20px;padding:20px;}
.box,.card{background:rgba(20,30,50,0.95);padding:20px;border-radius:15px;margin-bottom:15px;}
.card{box-shadow:0 0 15px #6a00ff;}
</style>
</head>
<body>

<button class="menu-btn" id="menuBtn" onclick="toggleMenu()">‚ò∞ Menu</button>
<div id="menu" class="menu"></div>
<div class="content" id="content"></div>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyAAOIbO-iUWQgjtIDtuwjUS2ViMoVo4Csc",
  authDomain: "key-system-54e4f.firebaseapp.com",
  projectId: "key-system-54e4f",
  storageBucket: "key-system-54e4f.firebasestorage.app",
  messagingSenderId: "59328259414",
  appId: "1:59328259414:web:aaa3188415ebceb12022f7",
  measurementId: "G-SD71Z2KVPC"
});
const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null, userData=null, isRegister=false;

/* MENU */
function toggleMenu(){
  const m=document.getElementById("menu");
  m.style.left=m.style.left=="0px"? "-260px":"0px";
}

/* LOGIN / REGISTRO */
function showAuth(){
  document.getElementById("menuBtn").style.display="none";
  const content=document.getElementById("content");
  content.innerHTML=`<div class="container">
    <h1>${isRegister?"Crie sua conta":"Bem-vindo de volta"}</h1>
    <p>${isRegister?"Digite seus dados para registrar":"Entre na sua conta para continuar"}</p>
    <input type="email" id="email" placeholder="Usu√°rio ou Email">
    <input type="password" id="pass" placeholder="Senha">
    <button id="loginBtn">${isRegister?"Registrar":"Entrar"}</button>
    <small id="toggleForm">${isRegister?"J√° possui uma conta? Entrar":"N√£o possui uma conta? Criar conta"}</small>
    <p id="message"></p>
  </div>`;

  document.getElementById("toggleForm").addEventListener('click',()=>{
    isRegister=!isRegister;
    showAuth();
  });

  document.getElementById("loginBtn").addEventListener('click',async ()=>{
    const email=document.getElementById("email").value.trim();
    const pass=document.getElementById("pass").value.trim();
    const message=document.getElementById("message");
    message.className="";
    if(!email||!pass){message.className="error"; message.innerText="Preencha todos os campos"; return;}
    if(!navigator.onLine){message.className="error"; message.innerText="Sem conex√£o!"; return;}

    try{
      if(isRegister){
        const res=await auth.createUserWithEmailAndPassword(email,pass);
        await db.collection("users").doc(res.user.uid).set({email:email,role:"USER",credits:0,created:Date.now()});
        message.className="success"; message.innerText="Conta criada com sucesso!";
        setTimeout(()=>{isRegister=false; showAuth();},1000);
      }else{
        const res=await auth.signInWithEmailAndPassword(email,pass);
        const snap=await db.collection("users").doc(res.user.uid).get();
        if(!snap.exists) throw new Error("Usu√°rio n√£o encontrado!");
        currentUser=res.user; userData=snap.data();
        showPanel();
      }
    }catch(err){
      message.className="error"; message.innerText=err.message;
    }
  });
}

/* PAINEL COMPLETO */
function showPanel(){
  document.getElementById("menuBtn").style.display="block";
  buildMenu();
  showDashboard();
}

function buildMenu(){
  const m=document.getElementById("menu");
  if(!userData) return;
  m.innerHTML=`<h3>${userData.role}</h3>
    <button onclick="showDashboard()">üìä Dashboard</button>
    <button onclick="showGenerate()">‚ö° Gerar Key</button>
    <button onclick="showMyKeys()">üîë Minhas Keys</button>
    ${userData.role==="ADM"?`
      <button onclick="showUsers()">üë§ Gerenciar Usu√°rios</button>
      <button onclick="showAllKeys()">üîë Todas Keys</button>`:''}
    <button onclick="logout()">Sair</button>`;
}

function logout(){ auth.signOut(); currentUser=null; userData=null; isRegister=false; showAuth(); }

/* DASHBOARD */
async function showDashboard(){
  if(!navigator.onLine){ content.innerHTML="<p class='error'>Sem conex√£o!</p>"; return; }
  const snap=await db.collection("keys").where("owner","==",currentUser.uid).get();
  document.getElementById("content").innerHTML=`<div class="card"><h2>Dashboard</h2><p>Total de keys: ${snap.size}</p></div>`;
}

/* GERAR KEYS */
function showGenerate(){
  const content=document.getElementById("content");
  content.innerHTML=`<div class="card">
    <h2>Gerar Key</h2>
    <select id="days">
      <option value="1">24h - 1 cr√©dito</option>
      <option value="3">3 dias - 5 cr√©ditos</option>
      <option value="5">5 dias - 10 cr√©ditos</option>
      <option value="15">15 dias - 20 cr√©ditos</option>
      <option value="30">30 dias - 30 cr√©ditos</option>
    </select><br><br>
    <button onclick="generateKey()">Gerar</button>
    <p id="errorGenerate" class="error"></p>
  </div>`;
}

async function generateKey(){
  const map={1:1,3:5,5:10,15:20,30:30};
  const d=parseInt(document.getElementById("days").value);
  const cost=map[d];
  const errorP=document.getElementById("errorGenerate");
  try{
    if(!navigator.onLine) throw new Error("Sem conex√£o!");
    if(userData.role!=="ADM" && userData.credits<cost) throw new Error("Sem cr√©ditos!");
    const key="KEY-"+Math.random().toString(36).substr(2,8).toUpperCase();
    const exp=Date.now()+d*86400000;
    await db.collection("keys").add({key:key,owner:currentUser.uid,created:Date.now(),expires:exp,paused:false});
    if(userData.role!=="ADM") await db.collection("users").doc(currentUser.uid)
      .update({credits:firebase.firestore.FieldValue.increment(-cost)});
    alert("Key gerada: "+key);
    showMyKeys();
  }catch(err){ errorP.innerText=err.message; }
}

/* MINHAS KEYS */
async function showMyKeys(){
  if(!navigator.onLine){ document.getElementById("content").innerHTML="<p class='error'>Sem conex√£o!</p>"; return; }
  const snap=await db.collection("keys").where("owner","==",currentUser.uid).get();
  const content=document.getElementById("content");
  content.innerHTML="<h2>Minhas Keys</h2>";
  snap.forEach(d=>{
    const k=d.data();
    content.innerHTML+=`<div class="card">
      <b>${k.key}</b><br>Status: ${k.paused?"PAUSADA":"ATIVA"}<br>
      <small>Expira em: ${Math.max(0,Math.floor((k.expires-Date.now())/1000))}s</small><br>
      <button onclick="toggleKey('${d.id}',${k.paused})">Pausar/Ativar</button>
    </div>`;
  });
}
function toggleKey(id,state){
  db.collection("keys").doc(id).update({paused:!state});
  showMyKeys();
}

/* ADM USU√ÅRIOS */
async function showUsers(){
  if(!navigator.onLine){ document.getElementById("content").innerHTML="<p class='error'>Sem conex√£o!</p>"; return; }
  const snap=await db.collection("users").get();
  const content=document.getElementById("content");
  content.innerHTML="<h2>Usu√°rios</h2>";
  snap.forEach(d=>{
    const u=d.data();
    content.innerHTML+=`<div class="card">${u.email} | Cr√©ditos: ${u.credits}<br>
      <button onclick="db.collection('users').doc('${d.id}').update({credits:firebase.firestore.FieldValue.increment(5)})">+5 Cr√©ditos</button>
    </div>`;
  });
}

/* ADM TODAS KEYS */
async function showAllKeys(){
  if(!navigator.onLine){ document.getElementById("content").innerHTML="<p class='error'>Sem conex√£o!</p>"; return; }
  const snap=await db.collection("keys").get();
  const content=document.getElementById("content");
  content.innerHTML="<h2>Todas Keys</h2>";
  snap.forEach(d=>{ content.innerHTML+=`<div class='card'>${d.data().key}</div>`; });
}

/* VERIFICA AUTENTICA√á√ÉO AO CARREGAR */
auth.onAuthStateChanged(user=>{
  if(user){ currentUser=user;
    db.collection("users").doc(user.uid).get().then(snap=>{
      if(snap.exists){ userData=snap.data(); showPanel(); }else{ showAuth(); }
    }).catch(()=>{showAuth();});
  }else showAuth();
});
</script>
</body>
</html>
