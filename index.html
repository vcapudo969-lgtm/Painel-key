<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Key System - Gamer</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  margin:0;
  font-family: 'Orbitron', Arial, sans-serif;
  background: linear-gradient(135deg,#0b0f16,#0a1c2e);
  color:#fff;
}
.menu-btn{
  position:fixed; top:10px; left:10px;
  background:#1a1f35; color:#fff; border:none;
  padding:8px 10px; border-radius:6px; cursor:pointer; z-index:999;
}
.menu{
  position:fixed; top:0; left:-260px;
  width:240px; height:100%; background:#0f1428; padding:15px; transition:0.3s; z-index:998;
}
.menu button{
  width:100%; margin:5px 0; padding:10px;
  background:#1a1f35; color:white; border:none; border-radius:6px; cursor:pointer;
}
.content{ margin-left:20px; padding:20px; }
.box{
  background: rgba(20,30,50,0.95); padding:40px; border-radius:15px; width:380px;
  text-align:center; box-shadow: 0 0 25px #6a00ff; margin:auto; margin-top:50px;
}
h2{ font-size:32px; margin-bottom:20px; color:#6a00ff; text-shadow:0 0 10px #fff; }
input,button,select{ width:100%; padding:12px; margin:8px 0; border:none; border-radius:10px; font-size:16px; }
button{ background: linear-gradient(45deg,#6a00ff,#ff00aa); color:white; font-weight:bold; transition:0.3s; }
button:hover{ transform:scale(1.05); box-shadow: 0 0 15px #ff00aa; }
small{ color:#aaa; cursor:pointer; display:block; margin-top:10px; font-size:14px; }
small:hover{ color:#6a00ff; text-shadow:0 0 5px #fff; }
.card{ background:#11162a; padding:15px; border-radius:10px; margin-bottom:10px; }
.error{ color:#ff4d4d; font-weight:bold; }
</style>
</head>

<body>

<button class="menu-btn" onclick="toggleMenu()">‚ò∞ Menu</button>
<div id="menu" class="menu"></div>
<div class="content" id="content"></div>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyAAOIbO-iUWQgjtIDtuwjUS2ViMoVo4Csc",
  authDomain: "key-system-54e4f.firebaseapp.com",
  projectId: "key-system-54e4f",
  storageBucket: "key-system-54e4f.firebasestorage.app",
  messagingSenderId: "59328259414",
  appId: "1:59328259414:web:aaa3188415ebceb12022f7",
  measurementId: "G-SD71Z2KVPC"
});
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser, userData;

/* MENU */
function toggleMenu(){
  const m = document.getElementById("menu");
  m.style.left = m.style.left=="0px" ? "-260px" : "0px";
}

/* LOGIN / REGISTRO */
showLogin();

function showLogin(){
  content.innerHTML = `<div class="box">
    <h2>LOGIN</h2>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Senha"><br>
    <button onclick="login()">Entrar</button>
    <small onclick="showRegister()">Criar conta</small>
    <p id="errorLogin" class="error"></p>
  </div>`;
}

function showRegister(){
  content.innerHTML = `<div class="box">
    <h2>REGISTRO</h2>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Senha"><br>
    <button onclick="register()">Registrar</button>
    <small onclick="showLogin()">J√° tenho conta</small>
    <p id="errorRegister" class="error"></p>
  </div>`;
}

/* LOGIN */
function login(){
  const emailVal = document.getElementById("email").value;
  const passVal = document.getElementById("pass").value;
  const errorP = document.getElementById("errorLogin");

  if(!navigator.onLine){
    errorP.innerText = "Sem conex√£o com a internet!";
    return;
  }

  auth.signInWithEmailAndPassword(emailVal, passVal)
    .then(async uc=>{
      currentUser = uc.user;
      try{
        const snap = await db.collection("users").doc(currentUser.uid).get();
        if(!snap.exists) throw new Error("Usu√°rio n√£o encontrado no Firestore");
        userData = snap.data();
        buildMenu();
        showDashboard();
      }catch(err){
        errorP.innerText = "Erro Firestore: "+err.message;
      }
    })
    .catch(e=>errorP.innerText = "Erro Auth: "+e.message);
}

/* REGISTRO */
function register(){
  const emailVal = document.getElementById("email").value;
  const passVal = document.getElementById("pass").value;
  const errorP = document.getElementById("errorRegister");

  if(!navigator.onLine){
    errorP.innerText = "Sem conex√£o com a internet!";
    return;
  }

  auth.createUserWithEmailAndPassword(emailVal, passVal)
    .then(async r=>{
      try{
        await db.collection("users").doc(r.user.uid).set({
          email: emailVal,
          role:"USER",
          credits:0,
          created:Date.now()
        });
        alert("Conta criada com sucesso!");
        showLogin();
      }catch(err){
        errorP.innerText = "Erro Firestore: "+err.message;
      }
    }).catch(e=>errorP.innerText = "Erro Auth: "+e.message);
}

/* USU√ÅRIO LOGADO */
auth.onAuthStateChanged(async user=>{
  if(!user) return;
  currentUser = user;
  try{
    if(!navigator.onLine){
      content.innerHTML = `<p class="error">Sem conex√£o com a internet!</p>`;
      return;
    }
    const snap = await db.collection("users").doc(currentUser.uid).get();
    if(!snap.exists) throw new Error("Usu√°rio n√£o encontrado no Firestore");
    userData = snap.data();
    buildMenu();
    showDashboard();
  }catch(err){
    content.innerHTML = `<p class="error">Erro Firestore: ${err.message}</p>`;
  }
});

/* MENU */
function buildMenu(){
  const m = document.getElementById("menu");
  m.innerHTML = `<h3>${userData.role}</h3>
    <button onclick="showDashboard()">üìä Dashboard</button>
    <button onclick="showGenerate()">‚ö° Gerar Key</button>
    <button onclick="showMyKeys()">üîë Minhas Keys</button>
    ${userData.role==="ADM"?`
      <button onclick="showUsers()">üë§ Usu√°rios</button>
      <button onclick="showAllKeys()">üîë Todas Keys</button>`:""}
    <button onclick="logout()">Sair</button>`;
}

/* LOGOUT */
function logout(){ auth.signOut(); location.reload(); }

/* DASHBOARD */
async function showDashboard(){
  try{
    if(!navigator.onLine){
      content.innerHTML = `<p class="error">Sem conex√£o com a internet!</p>`;
      return;
    }
    const snap = await db.collection("keys").where("owner","==",currentUser.uid).get();
    content.innerHTML = `<div class="card"><h2>Dashboard</h2>
      <p>Total de keys: ${snap.size}</p>
    </div>`;
  }catch(err){
    content.innerHTML = `<p class="error">Erro Firestore: ${err.message}</p>`;
  }
}

/* GERAR KEYS */
function showGenerate(){
  content.innerHTML = `<div class="card">
    <h2>Gerar Key</h2>
    <select id="days">
      <option value="1">24h - 1 cr√©dito</option>
      <option value="3">3 dias - 5 cr√©ditos</option>
      <option value="5">5 dias - 10 cr√©ditos</option>
      <option value="15">15 dias - 20 cr√©ditos</option>
      <option value="30">30 dias - 30 cr√©ditos</option>
    </select><br><br>
    <button onclick="generateKey()">Gerar</button>
    <p id="errorGenerate" class="error"></p>
  </div>`;
}

async function generateKey(){
  const map={1:1,3:5,5:10,15:20,30:30};
  const d=parseInt(document.getElementById("days").value);
  const cost = map[d];
  const errorP = document.getElementById("errorGenerate");

  try{
    if(!navigator.onLine){ throw new Error("Sem conex√£o com a internet!"); }
    if(userData.role!=="ADM" && userData.credits<cost){ throw new Error("Sem cr√©ditos"); }

    const key = "KEY-"+Math.random().toString(36).substr(2,8).toUpperCase();
    const exp = Date.now()+d*86400000;

    await db.collection("keys").add({
      key:key,
      owner:currentUser.uid,
      created:Date.now(),
      expires:exp,
      paused:false
    });

    if(userData.role!=="ADM"){
      await db.collection("users").doc(currentUser.uid)
        .update({credits: firebase.firestore.FieldValue.increment(-cost)});
    }
    alert("Key gerada: "+key);
    showMyKeys();
  }catch(err){
    errorP.innerText = err.message;
  }
}

/* MINHAS KEYS */
async function showMyKeys(){
  try{
    if(!navigator.onLine){
      content.innerHTML = `<p class="error">Sem conex√£o com a internet!</p>`;
      return;
    }
    const snap = await db.collection("keys").where("owner","==",currentUser.uid).get();
    content.innerHTML = "<h2>Minhas Keys</h2>";
    snap.forEach(d=>{
      const k=d.data();
      content.innerHTML+=`<div class="card">
        <b>${k.key}</b><br>
        Status: ${k.paused?"PAUSADA":"ATIVA"}<br>
        <small>Expira em: ${Math.max(0,Math.floor((k.expires-Date.now())/1000))}s</small><br>
        <button onclick="toggleKey('${d.id}',${k.paused})">Pausar/Ativar</button>
      </div>`;
    });
  }catch(err){
    content.innerHTML = `<p class="error">Erro Firestore: ${err.message}</p>`;
  }
}

function toggleKey(id,state){
  db.collection("keys").doc(id).update({paused:!state});
  showMyKeys();
}

/* ADM USU√ÅRIOS */
async function showUsers(){
  try{
    if(!navigator.onLine){ content.innerHTML = `<p class="error">Sem conex√£o com a internet!</p>`; return; }
    const snap = await db.collection("users").get();
    content.innerHTML="<h2>Usu√°rios</h2>";
    snap.forEach(d=>{
      const u=d.data();
      content.innerHTML+=`<div class="card">
        ${u.email} | Cr√©ditos: ${u.credits}<br>
        <button onclick="db.collection('users').doc('${d.id}')
          .update({credits:firebase.firestore.FieldValue.increment(5)})">+5 Cr√©ditos</button>
      </div>`;
    });
  }catch(err){
    content.innerHTML = `<p class="error">Erro Firestore: ${err.message}</p>`;
  }
}

/* ADM TODAS KEYS */
async function showAllKeys(){
  try{
    if(!navigator.onLine){ content.innerHTML = `<p class="error">Sem conex√£o com a internet!</p>`; return; }
    const snap = await db.collection("keys").get();
    content.innerHTML="<h2>Todas Keys</h2>";
    snap.forEach(d=>{ content.innerHTML+=`<div class="card">${d.data().key}</div>`; });
  }catch(err){
    content.innerHTML = `<p class="error">Erro Firestore: ${err.message}</p>`;
  }
}
</script>

</body>
</html>
