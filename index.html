<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Key System - Gamer</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {margin:0;font-family:'Orbitron',Arial,sans-serif;background:linear-gradient(135deg,#0b0f16,#0a1c2e);color:#fff;}
.menu-btn{position:fixed;top:10px;left:10px;background:#1a1f35;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;z-index:999;}
.menu{position:fixed;top:0;left:-260px;width:240px;height:100%;background:#0f1428;padding:15px;transition:0.3s;z-index:998;}
.menu button{width:100%;margin:5px 0;padding:10px;background:#1a1f35;color:white;border:none;border-radius:6px;cursor:pointer;}
.content{margin-left:20px;padding:20px;}
.box{background:rgba(20,30,50,0.95);padding:40px;border-radius:15px;width:380px;text-align:center;box-shadow:0 0 25px #6a00ff;margin:auto;margin-top:50px;}
h2{font-size:32px;margin-bottom:20px;color:#6a00ff;text-shadow:0 0 10px #fff;}
input,button,select{width:100%;padding:12px;margin:8px 0;border:none;border-radius:10px;font-size:16px;}
button{background:linear-gradient(45deg,#6a00ff,#ff00aa);color:white;font-weight:bold;transition:0.3s;}
button:hover{transform:scale(1.05);box-shadow:0 0 15px #ff00aa;}
small{color:#aaa;cursor:pointer;display:block;margin-top:10px;font-size:14px;}
small:hover{color:#6a00ff;text-shadow:0 0 5px #fff;}
.card{background:#11162a;padding:15px;border-radius:10px;margin-bottom:10px;}
.error{color:#ff4d4d;font-weight:bold;}
</style>
</head>
<body>

<button class="menu-btn" onclick="toggleMenu()">‚ò∞ Menu</button>
<div id="menu" class="menu"></div>
<div class="content" id="content"></div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAAOIbO-iUWQgjtIDtuwjUS2ViMoVo4Csc",
  authDomain: "key-system-54e4f.firebaseapp.com",
  projectId: "key-system-54e4f",
  storageBucket: "key-system-54e4f.firebasestorage.app",
  messagingSenderId: "59328259414",
  appId: "1:59328259414:web:aaa3188415ebceb12022f7",
  measurementId: "G-SD71Z2KVPC"
});
const auth = firebase.auth();
const db = firebase.firestore();
let currentUser=null, userData=null;

function toggleMenu(){
  const m=document.getElementById("menu");
  m.style.left=m.style.left=="0px"? "-260px":"0px";
}

/* LOGIN / REGISTRO */
function showLogin(){
  content.innerHTML = `<div class="box">
    <h2>LOGIN</h2>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Senha"><br>
    <button onclick="login()">Entrar</button>
    <small onclick="showRegister()">Criar conta</small>
    <p id="errorLogin" class="error"></p>
  </div>`;
}
function showRegister(){
  content.innerHTML = `<div class="box">
    <h2>REGISTRO</h2>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Senha"><br>
    <button onclick="register()">Registrar</button>
    <small onclick="showLogin()">J√° tenho conta</small>
    <p id="errorRegister" class="error"></p>
  </div>`;
}

/* LOGIN */
function login(){
  const email=document.getElementById("email").value;
  const pass=document.getElementById("pass").value;
  const errorP=document.getElementById("errorLogin");
  if(!navigator.onLine){ errorP.innerText="Sem conex√£o!"; return; }
  auth.signInWithEmailAndPassword(email,pass)
    .then(async u=>{
      currentUser=u.user;
      await loadUserData();
    })
    .catch(e=>errorP.innerText="Erro Auth: "+e.message);
}

/* REGISTRO */
function register(){
  const email=document.getElementById("email").value;
  const pass=document.getElementById("pass").value;
  const errorP=document.getElementById("errorRegister");
  if(!navigator.onLine){ errorP.innerText="Sem conex√£o!"; return; }
  auth.createUserWithEmailAndPassword(email,pass)
    .then(async u=>{
      await db.collection("users").doc(u.user.uid).set({
        email:email,role:"USER",credits:0,created:Date.now()
      });
      alert("Conta criada!");
      showLogin();
    })
    .catch(e=>errorP.innerText="Erro Auth: "+e.message);
}

/* LOAD USER DATA */
async function loadUserData(){
  if(!navigator.onLine){ content.innerHTML="<p class='error'>Sem conex√£o!</p>"; return; }
  try{
    const snap=await db.collection("users").doc(currentUser.uid).get();
    if(!snap.exists) throw new Error("Usu√°rio n√£o encontrado!");
    userData=snap.data();
    buildMenu();
    showDashboard();
  }catch(err){ content.innerHTML="<p class='error'>"+err.message+"</p>"; }
}

/* AUTH STATE CHANGE */
auth.onAuthStateChanged(user=>{
  if(user){ currentUser=user; loadUserData(); } 
  else { showLogin(); }
});

/* MENU */
function buildMenu(){
  const m=document.getElementById("menu");
  if(!userData) return;
  m.innerHTML=`<h3>${userData.role}</h3>
    <button onclick="showDashboard()">üìä Dashboard</button>
    <button onclick="showGenerate()">‚ö° Gerar Key</button>
    <button onclick="showMyKeys()">üîë Minhas Keys</button>
    ${userData.role==="ADM"?`
      <button onclick="showUsers()">üë§ Gerenciar Usu√°rios</button>
      <button onclick="showAllKeys()">üîë Todas Keys</button>`:''}
    <button onclick="logout()">Sair</button>`;
}

/* LOGOUT */
function logout(){ auth.signOut(); currentUser=null; userData=null; showLogin(); }

/* DASHBOARD */
async function showDashboard(){
  if(!navigator.onLine){ content.innerHTML="<p class='error'>Sem conex√£o!</p>"; return; }
  const snap=await db.collection("keys").where("owner","==",currentUser.uid).get();
  content.innerHTML=`<div class="card"><h2>Dashboard</h2><p>Total de keys: ${snap.size}</p></div>`;
}

/* GERAR KEYS */
function showGenerate(){
  content.innerHTML=`<div class="card">
    <h2>Gerar Key</h2>
    <select id="days">
      <option value="1">24h - 1 cr√©dito</option>
      <option value="3">3 dias - 5 cr√©ditos</option>
      <option value="5">5 dias - 10 cr√©ditos</option>
      <option value="15">15 dias - 20 cr√©ditos</option>
      <option value="30">30 dias - 30 cr√©ditos</option>
    </select><br><br>
    <button onclick="generateKey()">Gerar</button>
    <p id="errorGenerate" class="error"></p>
  </div>`;
}
async function generateKey(){
  const map={1:1,3:5,5:10,15:20,30:30};
  const d=parseInt(document.getElementById("days").value);
  const cost=map[d];
  const errorP=document.getElementById("errorGenerate");
  try{
    if(!navigator.onLine) throw new Error("Sem conex√£o!");
    if(userData.role!=="ADM" && userData.credits<cost) throw new Error("Sem cr√©ditos!");
    const key="KEY-"+Math.random().toString(36).substr(2,8).toUpperCase();
    const exp=Date.now()+d*86400000;
    await db.collection("keys").add({key:key,owner:currentUser.uid,created:Date.now(),expires:exp,paused:false});
    if(userData.role!=="ADM")
      await db.collection("users").doc(currentUser.uid).update({credits:firebase.firestore.FieldValue.increment(-cost)});
    alert("Key gerada: "+key);
    showMyKeys();
  }catch(err){ errorP.innerText=err.message; }
}

/* MINHAS KEYS */
async function showMyKeys(){
  if(!navigator.onLine){ content.innerHTML="<p class='error'>Sem conex√£o!</p>"; return; }
  const snap=await db.collection("keys").where("owner","==",currentUser.uid).get();
  content.innerHTML="<h2>Minhas Keys</h2>";
  snap.forEach(d=>{
    const k=d.data();
    content.innerHTML+=`<div class="card">
      <b>${k.key}</b><br>Status: ${k.paused?"PAUSADA":"ATIVA"}<br>
      <small>Expira em: ${Math.max(0,Math.floor((k.expires-Date.now())/1000))}s</small><br>
      <button onclick="toggleKey('${d.id}',${k.paused})">Pausar/Ativar</button>
    </div>`;
  });
}
function toggleKey(id,state){
  db.collection("keys").doc(id).update({paused:!state});
  showMyKeys();
}

/* ADM USERS */
async function showUsers(){
  if(!navigator.onLine){ content.innerHTML="<p class='error'>Sem conex√£o!</p>"; return; }
  const snap=await db.collection("users").get();
  content.innerHTML="<h2>Usu√°rios</h2>";
  snap.forEach(d=>{
    const u=d.data();
    content.innerHTML+=`<div class="card">${u.email} | Cr√©ditos: ${u.credits}<br>
      <button onclick="db.collection('users').doc('${d.id}')
        .update({credits:firebase.firestore.FieldValue.increment(5)})">+5 Cr√©ditos</button>
    </div>`;
  });
}

/* ADM TODAS KEYS */
async function showAllKeys(){
  if(!navigator.onLine){ content.innerHTML="<p class='error'>Sem conex√£o!</p>"; return; }
  const snap=await db.collection("keys").get();
  content.innerHTML="<h2>Todas Keys</h2>";
  snap.forEach(d=>{ content.innerHTML+=`<div class='card'>${d.data().key}</div>`; });
}
</script>
</body>
</html>
